name: Roadmap Auto Sync

on:
  push:
    branches-ignore:
      - master
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  roadmap-autosync:
    runs-on: ubuntu-latest
    if: ${{ (secrets.ROADMAP_AUTOSYNC_URL != '' && secrets.ROADMAP_AUTOSYNC_TOKEN != '') || (secrets.SUPABASE_URL != '' && secrets.SUPABASE_SERVICE_ROLE_KEY != '') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Auto-sync roadmap
        env:
          ROADMAP_AUTOSYNC_URL: ${{ secrets.ROADMAP_AUTOSYNC_URL }}
          ROADMAP_AUTOSYNC_TOKEN: ${{ secrets.ROADMAP_AUTOSYNC_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          ROADMAP_AUTOSYNC_BASE_REF: origin/master
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
        run: node scripts/roadmap-auto-sync.mjs
