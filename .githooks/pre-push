#!/usr/bin/env bash
set -euo pipefail

remote_name="${1:-origin}"

git fetch --quiet "$remote_name" || {
  echo "No se pudo hacer fetch de $remote_name. Aborta el push." >&2
  exit 1
}

if ! upstream=$(git rev-parse --abbrev-ref --symbolic-full-name "@{u}" 2>/dev/null); then
  echo "Aviso: no hay upstream configurado. Para evitar pisadas usa: git push -u $remote_name <branch>" >&2
  exit 0
fi

ahead=$(git rev-list --count "${upstream}..HEAD" || echo 0)
behind=$(git rev-list --count "HEAD..${upstream}" || echo 0)

if [ "$behind" -gt 0 ]; then
  echo "El remoto tiene $behind commit(s) que no tienes. Corre: git pull --rebase" >&2
  exit 1
fi

if [ -n "${ROADMAP_AUTOSYNC_URL:-}" ] && [ -n "${ROADMAP_AUTOSYNC_TOKEN:-}" ]; then
  if command -v node >/dev/null 2>&1; then
    echo "Ejecutando roadmap auto-sync..."
    node scripts/roadmap-auto-sync.mjs || {
      echo "Roadmap auto-sync fallo. Aborta el push." >&2
      exit 1
    }
  else
    echo "Node no disponible; no se pudo ejecutar roadmap auto-sync." >&2
  fi
else
  echo "Aviso: define ROADMAP_AUTOSYNC_URL y ROADMAP_AUTOSYNC_TOKEN para auto-sync en pre-push."
fi

if [ "$ahead" -eq 0 ]; then
  echo "No hay commits para pushear."
fi
